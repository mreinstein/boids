<!doctype html>
<html>
<head>
    <title>Boids Follow Leader Example</title>
    <meta name=theme-color content=#303F9F><meta name=viewport content="width=device-width,minimum-scale=1">
    <style>
        body {
          font-family: monospace;
          background-color: white;
          text-align: center;
          padding: 60px 0px;
        }

        canvas {
            padding: 0px;
            border:  1px solid #cacaca;
        }

    </style>
</head>
<body>

<h1>Follow Leader</h1>
<canvas width="400" height="240"></canvas>

<script type="module">
import * as Boids  from '../src/steering-arcade.js'
import * as Common from './common.js'
import { vec2 }    from 'https://cdn.skypack.dev/pin/gl-matrix@v3.4.3-OSmwlRYK5GW1unkuAQkN/mode=imports,min/optimized/gl-matrix.js'


function animate (t) {
    const dt = (t - (last || t)) / 1000
    last = t

    vec2.set(tmpForce, 0, 0)

    Boids.steerForArrival(tmpForce, leader, target)
    Boids.applySteeringForce(leader, tmpForce, dt)

    // Euler integrate (per frame) velocity into position
    vec2.add(leader.transform.position, leader.transform.position, leader.rigidBody.velocity)

    // update rotation to match boid's heading
    leader.transform.rotation = Math.atan2(leader.rigidBody.velocity[1], leader.rigidBody.velocity[0])


    for (const boid of neighbors) {
        vec2.set(tmpForce, 0, 0)
        Boids.steerForFollowLeader(tmpForce, boid, leader, neighbors)

        Boids.applySteeringForce(boid, tmpForce, dt)

        // Euler integrate (per frame) velocity into position
        vec2.scaleAndAdd(boid.transform.position, boid.transform.position, boid.rigidBody.velocity, dt)

        // update rotation to match boid's heading
        boid.transform.rotation = Math.atan2(boid.rigidBody.velocity[1], boid.rigidBody.velocity[0])
    }


    context.clearRect(0, 0, canvas.width, canvas.height)

    Common.drawTarget(target, context)
    for (const b of neighbors)
        Common.drawBoid(b, context)

    Common.drawBoid(leader, context, 'dodgerblue')

    requestAnimationFrame(animate)
}


const canvas = document.querySelector('canvas')
const context = canvas.getContext('2d')


let last = 0

const tmpForce = [ 0, 0 ]
const tmpForce2 = [ 0, 0 ]

const leader = Common.createBoid({ x: 50, y: 75, maxSpeed: 60, maxForce: 8 })
const b = Common.createBoid({ x: 50, y: 50, maxSpeed: 60, maxForce: 8 })
const b2 = Common.createBoid({ x: 50, y: 100, maxSpeed: 60, maxForce: 8 })
const b3 = Common.createBoid({ x: 50, y: 140, maxSpeed: 60, maxForce: 8 })
const b4 = Common.createBoid({ x: 350, y: 200, maxSpeed: 60, maxForce: 8 })

const neighbors = [ b, b2, b3, b4 ]

const target = [ 200, 150 ]

canvas.addEventListener('mousemove', function (ev) {
    vec2.set(target, ev.offsetX, ev.offsetY)
})

requestAnimationFrame(animate)

</script>

</body>
</html>